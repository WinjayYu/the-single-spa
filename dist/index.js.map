{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["let appLocationToApp = {};\nlet unhandledRouteHandlers = [];\nlet mountedApp;\nconst nativeAddEventListener = window.addEventListener;\nconst nativeSystemGlobal = window.System;\nconst requiredLifeCycleFuncs = [\n  'scriptsWillBeLoaded',\n  'scriptsWereLoaded',\n  'applicationWillMount',\n  'applicationWasMounted',\n  'applicationWillUnmount',\n  'applicationWasUnmounted',\n  'activeApplicationSourceWillUpdate',\n  'activeApplicationSourceWillUpdate'\n];\n\nwindow.singlespa = function (element) {\n  window.history.pushState(undefined, '', element.getAttribute('href'));\n  setTimeout(function () {\n    triggerAppChange();\n  }, 10);\n  return false;\n}\n\n/**\n * 在基座注册子应用的方法，eg:\n * declareChildApplication('https://path/to/your/app1.js', () => window.location.pathname.startsWith('app1'))\n * declareChildApplication('https://path/to/your/app2.js', () => window.location.pathname.startsWith('app2'))\n * @param {*} appLocation string 子应用打包后的 js 文件地址\n * @param {*} activeWhen function 子应用加载的条件，根据 URL 判断\n */\n\nexport function declareChildApplication(appLocation, activeWhen) {\n  if (typeof appLocation !== 'string' || appLocation.length === 0)\n    throw new Error(`The first argument must be a non-empty string 'appLocation'`);\n  if (typeof activeWhen !== 'function')\n    throw new Error(`The second argument must be a function 'activeWhen'`);\n  if (appLocationToApp[appLocation])\n    throw new Error(`There is already an app declared at location ${appLocation}`);\n\n  // 将子应用存到 appLocationToApp 对象里\n  appLocationToApp[appLocation] = {\n    appLocation: appLocation,\n    activeWhen: activeWhen,\n    parentApp: mountedApp ? mountedApp.appLocation : null\n  };\n\n  triggerAppChange();\n}\n\nexport function addUnhandledRouteHandler(handler) {\n  if (typeof handler !== 'function') {\n    throw new Error(`The first argument must be a handler function`);\n  }\n  unhandledRouteHandlers.push(handler);\n}\n\nexport function updateApplicationSourceCode(appName) {\n  if (!appLocationToApp[appName]) {\n    throw new Error(`No such app '${appName}'`);\n  }\n  let app = appLocationToApp[appName];\n  app.lifecycleFunctions.activeApplicationSourceWillUpdate()\n    .then((resolve) => {\n      //TODO reload the app\n      resolve()\n    })\n    .then(app.lifecycleFunctions.activeApplicationSourceWasUpdated);\n}\n\nfunction callLifecycleFunction(app, funcName, ...args) {\n  return new Promise((resolve) => {\n    callFunc(0);\n    function callFunc(i) {\n      app.lifecycles[i][funcName](...args)\n        .then(() => {\n          if (i === app.lifecycles.length - 1) {\n            resolve();\n          } else {\n            callFunc(++i);\n          }\n        })\n    }\n  })\n}\n\n/**\n * 找到当前 URL 对应的子应用，并触发它的生命周期\n */\nfunction triggerAppChange() {\n  let newApp = appForCurrentURL();\n  if (!newApp) {\n    unhandledRouteHandlers.forEach((handler) => {\n      handler(mountedApp);\n    });\n  }\n\n  if (newApp !== mountedApp) {\n    // 如果已经加载过其他子应用，先将其销毁\n    (mountedApp ? callLifecycleFunction(mountedApp, 'applicationWillUnmount') : new Promise((resolve) => resolve()))\n      // 清除 HTML 中所有的 DOM 元素（子应用加载后，会将它 HTML 的内容添加到基座 HTML 中，但此版本的 cleanupDom 函数会将 HTML 清空，包括基座的 DOM，这是存在问题的）\n      .then(() => cleanupDom())\n      .then(() => finishUnmountingApp(mountedApp))\n      .then(() => (mountedApp ? callLifecycleFunction(mountedApp, 'applicationWasUnmounted') : new Promise((resolve) => resolve())))\n      .then(() => (newApp.scriptsLoaded ? new Promise((resolve) => resolve()) : loadAppForFirstTime(newApp.appLocation)))\n      .then(() => callLifecycleFunction(newApp, 'applicationWillMount'))\n      .then(() => appWillBeMounted(newApp))\n      .then(() => insertDomFrom(newApp))\n      .then(() => callLifecycleFunction(newApp, 'applicationWasMounted'))\n      .then(() => mountedApp = newApp)\n  }\n}\n\nfunction cleanupDom() {\n  return new Promise((resolve) => {\n    // while (document.head.childNodes.length > 0) {\n    //   document.head.removeChild(document.head.childNodes[0]);\n    // }\n    // while (document.body.childNodes.length > 0) {\n    //   document.body.removeChild(document.body.childNodes[0]);\n    // }\n    resolve();\n  })\n}\n\nfunction insertDomFrom(app) {\n  return new Promise((resolve) => {\n    const deepClone = true;\n    let clonedAppDom = app.parsedDom.cloneNode(deepClone);\n\n    for (let i = 0; i < clonedAppDom.attributes.length; i++) {\n      const attr = clonedAppDom.attributes[i];\n      document.documentElement.setAttribute(attr.name, attr.value);\n    }\n\n    let appHead = app.parsedDom.querySelector('head');\n    while (appHead.childNodes.length > 0) {\n      document.head.appendChild(appHead.childNodes[0]);\n    }\n\n    let appBody = app.parsedDom.querySelector('body');\n    while (appBody.childNodes.length > 0) {\n      document.body.appendChild(appBody.childNodes[0]);\n    }\n\n    app.parsedDom = clonedAppDom;\n    resolve();\n  })\n}\n\nfunction loadAppForFirstTime(appLocation) {\n  return new Promise(function (resolve, reject) {\n    var currentAppSystemGlobal = window.System;\n    window.System = nativeSystemGlobal;\n    nativeSystemGlobal.import(appLocation).then(function (restOfApp) {\n      registerApplication(appLocation, restOfApp.publicRoot, restOfApp.pathToIndex, restOfApp.lifecycles);\n      let app = appLocationToApp[appLocation];\n      window.System = currentAppSystemGlobal;\n      callLifecycleFunction(app, 'scriptsWillBeLoaded')\n        .then(() => loadIndex(app))\n        .then(() => callLifecycleFunction(app, 'scriptsWereLoaded'))\n        .then(() => resolve())\n    })\n  })\n}\n\nfunction loadIndex(app) {\n  return new Promise((resolve) => {\n    let request = new XMLHttpRequest();\n    request.addEventListener('load', htmlLoaded);\n    request.open('GET', `${window.location.protocol}//${window.location.hostname}:${window.location.port}/${app.publicRoot}/${app.pathToIndex}`);\n    request.send();\n    function htmlLoaded() {\n      let parser = new DOMParser();\n      let dom = parser.parseFromString(this.responseText, 'text/html');\n      let isLoadingScript = false;\n      let scriptsToBeLoaded = [];\n\n      traverseNode(dom);\n      app.parsedDom = dom.documentElement;\n      if (app.scriptsLoaded) {\n        setTimeout(function () {\n          resolve();\n        }, 10)\n      }\n\n      function traverseNode(node) {\n        for (let i = 0; i < node.childNodes.length; i++) {\n          const child = node.childNodes[i];\n          if (child.tagName === 'SCRIPT') {\n            if (child.getAttribute('src')) {\n              child.setAttribute('src', prependURL(child.getAttribute('src'), app.publicRoot));\n            }\n            //we put the scripts onto the page as part of the scriptsLoaded lifecycle\n            scriptsToBeLoaded.push(child);\n            appendScriptTag();\n          } else if (child.tagName === 'LINK' && child.getAttribute('href')) {\n            child.setAttribute('href', prependURL(child.getAttribute('href'), app.publicRoot));\n          } else if (child.tagName === 'IMG' && child.getAttribute('src')) {\n            child.setAttribute('src', prependURL(child.getAttribute('src'), app.publicRoot));\n          }\n          traverseNode(child);\n        }\n      }\n\n      function prependURL(url, prefix) {\n        let parsedURL = document.createElement('a');\n        parsedURL.href = url;\n        let result = `${parsedURL.protocol}//` + `${parsedURL.hostname}:${parsedURL.port}/${prefix}/${parsedURL.pathname}${parsedURL.search}${parsedURL.hash}`.replace(/[\\/]+/g, '/');\n        return result;\n      }\n\n      function appendScriptTag() {\n        if (isLoadingScript) {\n          return;\n        }\n        if (scriptsToBeLoaded.length === 0) {\n          app.scriptsLoaded = true;\n          if (app.parsedDom) {\n            //loading a script was the last thing we were waiting on\n            setTimeout(function () {\n              resolve();\n            }, 10)\n          }\n          return;\n        }\n        let originalScriptTag = scriptsToBeLoaded.splice(0, 1)[0];\n        //one does not simply append script tags to the dom\n        let scriptTag = document.createElement('script');\n        for (let i = 0; i < originalScriptTag.attributes.length; i++) {\n          scriptTag.setAttribute(originalScriptTag.attributes[i].nodeName, originalScriptTag.getAttribute(originalScriptTag.attributes[i].nodeName));\n        }\n        if (!scriptTag.src) {\n          scriptTag.text = originalScriptTag.text;\n        }\n        isLoadingScript = true;\n        document.head.appendChild(scriptTag);\n        if (scriptTag.src) {\n          scriptTag.onload = () => {\n            isLoadingScript = false;\n            appendScriptTag();\n          }\n        } else {\n          isLoadingScript = false;\n          appendScriptTag();\n        }\n        //normally when you appendChild, the old parent no longer has the child anymore. We have to simulate that since we're not really appending the child\n        originalScriptTag.remove();\n      }\n    }\n  });\n}\n\nfunction registerApplication(appLocation, publicRoot, pathToIndex, lifecycles) {\n  //validate\n  if (typeof publicRoot !== 'string') {\n    throw new Error(`App ${appLocation} must export a publicRoot string`);\n  }\n  if (typeof pathToIndex !== 'string') {\n    throw new Error(`App ${appLocation} must export a pathToIndex string`);\n  }\n  if (typeof lifecycles !== 'object' && typeof lifecycles !== 'function') {\n    throw new Error(`App ${appLocation} must export a 'lifecycles' object or array of objects`);\n  }\n  if (!Array.isArray(lifecycles)) {\n    lifecycles = [lifecycles];\n  }\n  for (let i = 0; i < lifecycles.length; i++) {\n    requiredLifeCycleFuncs.forEach((requiredLifeCycleFunc) => {\n      if (typeof lifecycles[i][requiredLifeCycleFunc] !== 'function') {\n        throw new Error(`In app '${appLocation}', The lifecycle at index ${i} does not have required function ${requiredLifeCycleFunc}`);\n      }\n    });\n  }\n\n  //register\n  let app = appLocationToApp[appLocation];\n  app.publicRoot = publicRoot;\n  app.pathToIndex = pathToIndex;\n  app.hashChangeFunctions = [];\n  app.popStateFunctions = [];\n  app.lifecycles = lifecycles;\n}\n\nnativeAddEventListener('popstate', triggerAppChange);\n\n/**\n * 逐一执行子应用的 activeWhen 函数，如果当前的 URL 满足，则返回对应的子应用\n */\nfunction appForCurrentURL() {\n  let appsForCurrentUrl = [];\n  for (let appName in appLocationToApp) {\n    let app = appLocationToApp[appName];\n    if (app.activeWhen(window.location)) {\n      appsForCurrentUrl.push(app);\n    }\n  }\n  switch (appsForCurrentUrl.length) {\n    case 0:\n      return undefined;\n    case 1:\n      return appsForCurrentUrl[0];\n    default:\n      appNames = appsForCurrentUrl.map((app) => app.name);\n      throw new Error(`The following applications all claim to own the location ${window.location.href} -- ${appnames.toString()}`)\n  }\n}\n\nfunction appWillBeMounted(app) {\n  return new Promise((resolve) => {\n    app.hashChangeFunctions.forEach((hashChangeFunction) => {\n      nativeAddEventListener('hashchange', hashChangeFunction);\n    });\n    app.popStateFunctions.forEach((popStateFunction) => {\n      nativeAddEventListener('popstate', popStateFunction);\n    });\n    resolve();\n  })\n}\n\nfunction finishUnmountingApp(app) {\n  return new Promise((resolve) => {\n    if (!app) {\n      resolve()\n      return;\n    }\n    app.hashChangeFunctions.forEach((hashChangeFunction) => {\n      window.removeEventListener('hashchange', hashChangeFunction);\n    });\n    app.popStateFunctions.forEach((popStateFunction) => {\n      window.removeEventListener('popstate', popStateFunction);\n    });\n    resolve();\n  })\n}\n\nwindow.addEventListener = function (name, fn) {\n  if (mountedApp) {\n    if (name === 'popstate') {\n      mountedApp.popStateFunctions.push(fn);\n    } else if (name === 'hashchange') {\n      mountedApp.hashChangeFunctions.push(fn);\n    }\n    nativeAddEventListener.apply(this, arguments);\n  }\n}"],"names":["appLocationToApp","unhandledRouteHandlers","mountedApp","nativeAddEventListener","window","addEventListener","nativeSystemGlobal","System","requiredLifeCycleFuncs","singlespa","element","history","pushState","undefined","getAttribute","setTimeout","triggerAppChange","declareChildApplication","appLocation","activeWhen","length","Error","parentApp","addUnhandledRouteHandler","handler","push","updateApplicationSourceCode","appName","app","lifecycleFunctions","activeApplicationSourceWillUpdate","then","resolve","activeApplicationSourceWasUpdated","callLifecycleFunction","funcName","args","Promise","callFunc","i","lifecycles","newApp","appForCurrentURL","forEach","cleanupDom","finishUnmountingApp","scriptsLoaded","loadAppForFirstTime","appWillBeMounted","insertDomFrom","deepClone","clonedAppDom","parsedDom","cloneNode","attributes","attr","document","documentElement","setAttribute","name","value","appHead","querySelector","childNodes","head","appendChild","appBody","body","reject","currentAppSystemGlobal","restOfApp","registerApplication","publicRoot","pathToIndex","loadIndex","request","XMLHttpRequest","htmlLoaded","open","location","protocol","hostname","port","send","parser","DOMParser","dom","parseFromString","responseText","isLoadingScript","scriptsToBeLoaded","traverseNode","node","child","tagName","prependURL","appendScriptTag","url","prefix","parsedURL","createElement","href","result","pathname","search","hash","replace","originalScriptTag","splice","scriptTag","nodeName","src","text","onload","remove","Array","isArray","requiredLifeCycleFunc","hashChangeFunctions","popStateFunctions","appsForCurrentUrl","appNames","map","appnames","toString","hashChangeFunction","popStateFunction","removeEventListener","fn","apply","arguments"],"mappings":"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"}